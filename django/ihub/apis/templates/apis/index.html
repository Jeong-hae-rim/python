{% extends 'base.html' %}
{% load static %}

{% block link %}
  <link rel="stylesheet" href="{% static 'vendors/iconfonts/mdi/css/materialdesignicons.min.css' %}">
  <link rel="stylesheet" href="{% static 'vendors/css/vendor.bundle.base.css' %}">
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <link rel="shortcut icon" href="{% static 'images/favicon.png' %}" />
{% endblock  %}


{% block content %}
    {% include 'nav.html' %}

    <div class="container-fluid page-body-wrapper">
      <!-- Main Panel Start -->
      <div class="main-panel">
        <div class="content-wrapper">
          <!-- All Status Box -->
          <div class="row">
            <div class="col-md-4 stretch-card grid-margin">
              <div class="card bg-gradient-info card-img-holder text-white" style='height:150px;'>
                <div class="card-body">
                  <img src="{% static 'images/dashboard/circle.svg' %}" class="card-img-absolute" alt="circle-image"/>
                  <h4 class="font-weight-normal mb-3">API 
                    <i class="mdi mdi-chart-line mdi-24px float-right"></i>
                    <br> All
                  </h4>
                  <h2 class="mb-5">5000</h2>
                </div>
              </div>
            </div>
            <div class="col-md-4 stretch-card grid-margin">
              <div class="card bg-gradient-success card-img-holder text-white" style='height:150px;'>
                <div class="card-body">
                  <img src="{% static 'images/dashboard/circle.svg' %}" class="card-img-absolute" alt="circle-image"/>                  
                  <h4 class="font-weight-normal mb-3">API 
                    <i class="mdi mdi-emoticon mdi-24px float-right"></i>
                    <br> Good Status
                  </h4>
                  <h2 class="mb-5">4000</h2>
                </div>
              </div>
            </div>
            <div class="col-md-4 stretch-card grid-margin">
              <div class="card bg-gradient-danger card-img-holder text-white" style='height:150px;'>
                <div class="card-body">
                  <img src="{% static 'images/dashboard/circle.svg' %}" class="card-img-absolute" alt="circle-image"/>                                    
                  <h4 class="font-weight-normal mb-3">API
                    <i class="mdi mdi-emoticon-sad mdi-24px float-right"></i>
                    <br> Bad Status
                  </h4>
                  <h2 class="mb-5">1000</h2>
                </div>
              </div>
            </div>
          </div>
          <!-- Status Table -->
          <div class="col-12 grid-margin">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Recent Status</h4>
                <div class="row" style="margin-top:20px; margin-bottom:30px;">
                  <div class="search-field d-none d-md-block col-9">
                    <div class="input-group">
                      <form class="d-flex align-items-center h-100" autocomplete="off">
                        <input id="myInput" name="myCountry" type="text" class="form-control bg-transparent autocomplete" style="border:1px solid #F2F2F2; width:500px;" placeholder="API명을 입력하세요">
                      </form>
                        <div class="input-group-prepend bg-transparent">
                          <button data-toggle="modal" data-target="#modal-detail" id="userSearch" class="border-0"><i class="input-group-text border-0 mdi mdi-magnify"></i></button>               
                        </div>
                    </div>
                  </div>
                  
                  <div class="select-bar col-3">
                    <form action="" method="GET">
                      <select class="form-control bg-transparent" style="height:45px" name="순서">
                        <option value="">Select</option>
                        <option value="이름순">이름순</option>
                        <option value="최신순">최신순</option>
                        <option value="다운로드순">다운로드순</option>
                      </select>
                    </form>
                  </div>
                </div>
                <div class="table-responsive">
                  <table class="table" style="text-align:center">
                    <thead>
                      <tr>
                        <th>
                          API Name
                        </th>
                        <th>
                          Condition
                        </th>
                        <th>
                          Last Update
                        </th>
                        <th>
                          Download Status
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for api in apis %}
                        <tr>
                          <td>
                            <a href="" data-toggle="modal" data-target="#modal-detail" id='detail' data-id='{{ api.pk }}'>{{ api.api_name }}</a>
                          </td>
                          <td id='api{{ api.pk }}'>
                            {% comment %} {% if {{ api.pk }} ==  %}
                            
                            {% else %}

                            {% endif %}
                            <label id='api{{ api.pk }}'></label> {% endcomment %}
                          </td>
                          <td>
                            {{ api.latest_modified_date }}
                          </td>
                          <td>
                            <i class="mdi mdi-arrow-down-bold-circle-outline"></i>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Resources -->
          <script src="https://www.amcharts.com/lib/4/core.js"></script>
          <script src="https://www.amcharts.com/lib/4/charts.js"></script>
          <script src="https://www.amcharts.com/lib/4/themes/animated.js"></script>
          
          <!-- Chart code -->
          <script>
            am4core.ready(function() {

            // Themes begin
            am4core.useTheme(am4themes_animated);
            // Themes end


            // Create chart
            var chart = am4core.create("chartdiv", am4charts.XYChart);
            chart.paddingRight = 20;

            var data =  [ {
                    "day": new Date(2020, 07, 01, 10, 1),
                    "value":1,
                    "status":"정상"
                }, {
                    "day": new Date(2020, 07, 01, 10, 1),
                    "value":1,
                    "status":"정상"
                },{
                    "day": new Date(2020, 07, 02, 10, 1),
                    "value":1,
                    "status":"정상"
                },{
                    "day": new Date(2020, 07, 02, 10, 1),
                    "value":1,
                    "status":"정상"
                },{
                    "day": new Date(2020, 07, 03, 10, 1),
                    "value":1,
                    "status":"정상"
                }, {
                    "day": new Date(2020, 07, 03, 10, 2),
                    "value": 1,
                    "status":"정상"
                }, {
                    "day": new Date(2020, 07, 04, 10, 3),
                    "value": 1,
                    "status":"정상"
                }, {
                    "day": new Date(2020, 07, 04, 10, 4),
                    "value": 0,
                    "status":"다운"
                }, {
                    "day": new Date(2020, 07, 05, 10, 5),
                    "value": 0,
                    "status":"다운"
                }, {
                    "day": new Date(2020, 07, 05, 10, 6),
                    "value":1,
                    "status":"정상"
                }, {
                    "day": new Date(2020, 07, 06, 10, 7),
                    "value": 1,
                    "status":"정상"
                }
            ];

            chart.data = data;
            chart.dateFormatter.inputDateFormat = "yyyy-MM-dd";

            var dateAxis = chart.xAxes.push(new am4charts.DateAxis());
            dateAxis.renderer.minGridDistance = 50;
            // dateAxis.baseInterval = {timeUnit:"second", count:1};
            dateAxis.periodChangeDateFormats.setKey("second", "[bold]day");


            var valueAxis = chart.yAxes.push(new am4charts.ValueAxis());
            valueAxis.tooltip.disabled = true;
            valueAxis.renderer.disabled = true;
            console.log(valueAxis)

            var series = chart.series.push(new am4charts.StepLineSeries());
            series.dataFields.dateX = "day";
            series.dataFields.valueY = "value";
            series.tooltipText = "{status}";
            series.strokeWidth = 3;
            
            chart.cursor = new am4charts.XYCursor();
            chart.cursor.xAxis = dateAxis;
            chart.cursor.fullWidthLineX = true;
            chart.cursor.lineX.strokeWidth = 0;
            chart.cursor.lineX.fill = chart.colors.getIndex(2);
            chart.cursor.lineX.fillOpacity = 0.1;
            
            chart.scrollbarX = new am4core.Scrollbar();
            
            }); // end am4core.ready()
          </script>  

          <!-- Search bar -->
          <script>
              // 검색을 클릭했을 경우
              var showSearchDetail = document.querySelector('#userSearch');
              console.log(showSearchDetail);

              showSearchDetail.addEventListener('click', function(event){
                  document.querySelector('.modal-title').innerHTML = 'API 명을 정확히 입력해주세요'
                  document.querySelector('.modal-body-div').innerHTML = ''
                  let searchString = document.querySelector('#myInput');
                  console.log(searchString);
                  axios.get(`/apis/search/${searchString.value}/`)
                  .then(res => {
                      console.log(res.data.api_pk);
                      let targetId = res.data.api_pk;
                      axios.get(`/apis/${targetId}/detail/`)
                      .then(res => {
                          console.log(res.data)
                          document.querySelector('.modal-title').innerHTML = res.data.api_name
                          document.querySelector('.modal-body-div').innerHTML = 
                          '<div>최종수정일 : ' + res.data.latest_modified_date + '</div>' +
                          '<div>저작권자명 : ' + res.data.copyright + '</div>' +
                          '<div>라이센스 : ' + res.data.copyright_range + '</div>' +
                          '<div>다운로드수 : ' + res.data.download_users + '</div>'
                      })
                  })


              })
          </script>

          <!-- Auto Complete -->
          <script>
              var api_names = []
              {% for api in apis %}
                  api_names.push('{{ api.api_name }}')
              {% endfor %}
              console.log(api_names)

              function autocomplete(inp, arr) {
              /*the autocomplete function takes two arguments,
              the text field element and an array of possible autocompleted values:*/
              var currentFocus;
              /*execute a function when someone writes in the text field:*/
              inp.addEventListener("input", function(e) {
                  var a, b, i, val = this.value;
                  /*close any already open lists of autocompleted values*/
                  closeAllLists();
                  if (!val) { return false;}
                  currentFocus = -1;
                  /*create a DIV element that will contain the items (values):*/
                  a = document.createElement("DIV");
                  a.setAttribute("id", this.id + "autocomplete-list");
                  a.setAttribute("class", "autocomplete-items");
                  /*append the DIV element as a child of the autocomplete container:*/
                  this.parentNode.appendChild(a);
                  /*for each item in the array...*/
                  for (i = 0; i < arr.length; i++) {
                      /*check if the item starts with the same letters as the text field value:*/
                      if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                      /*create a DIV element for each matching element:*/
                      b = document.createElement("DIV");
                      /*make the matching letters bold:*/
                      b.innerHTML = "<strong>" + arr[i].substr(0, val.length) + "</strong>";
                      b.innerHTML += arr[i].substr(val.length);
                      /*insert a input field that will hold the current array item's value:*/
                      b.innerHTML += "<input type='hidden' value='" + arr[i] + "'>";
                      /*execute a function when someone clicks on the item value (DIV element):*/
                          b.addEventListener("click", function(e) {
                          /*insert the value for the autocomplete text field:*/
                          inp.value = this.getElementsByTagName("input")[0].value;
                          /*close the list of autocompleted values,
                          (or any other open lists of autocompleted values:*/
                          closeAllLists();
                      });
                      a.appendChild(b);
                      }
                  }
              });
              /*execute a function presses a key on the keyboard:*/
              inp.addEventListener("keydown", function(e) {
                  var x = document.getElementById(this.id + "autocomplete-list");
                  if (x) x = x.getElementsByTagName("div");
                  if (e.keyCode == 40) {
                      /*If the arrow DOWN key is pressed,
                      increase the currentFocus variable:*/
                      currentFocus++;
                      /*and and make the current item more visible:*/
                      addActive(x);
                  } else if (e.keyCode == 38) { //up
                      /*If the arrow UP key is pressed,
                      decrease the currentFocus variable:*/
                      currentFocus--;
                      /*and and make the current item more visible:*/
                      addActive(x);
                  } else if (e.keyCode == 13) {
                      /*If the ENTER key is pressed, prevent the form from being submitted,*/
                      e.preventDefault();
                      if (currentFocus > -1) {
                      /*and simulate a click on the "active" item:*/
                      if (x) x[currentFocus].click();
                      }
                  }
              });
              function addActive(x) {
                  /*a function to classify an item as "active":*/
                  if (!x) return false;
                  /*start by removing the "active" class on all items:*/
                  removeActive(x);
                  if (currentFocus >= x.length) currentFocus = 0;
                  if (currentFocus < 0) currentFocus = (x.length - 1);
                  /*add class "autocomplete-active":*/
                  x[currentFocus].classList.add("autocomplete-active");
              }
              function removeActive(x) {
                  /*a function to remove the "active" class from all autocomplete items:*/
                  for (var i = 0; i < x.length; i++) {
                  x[i].classList.remove("autocomplete-active");
                  }
              }
              function closeAllLists(elmnt) {
                  /*close all autocomplete lists in the document,
                  except the one passed as an argument:*/
                  var x = document.getElementsByClassName("autocomplete-items");
                  for (var i = 0; i < x.length; i++) {
                  if (elmnt != x[i] && elmnt != inp) {
                  x[i].parentNode.removeChild(x[i]);
                  }
              }
              }
              /*execute a function when someone clicks in the document:*/
              document.addEventListener("click", function (e) {
                  closeAllLists(e.target);
              });
            }
          </script>

          <!-- Auto Complete 실행 -->
          <script>
              autocomplete(document.getElementById("myInput"), api_names);
          </script>

          <!-- Modal Detail -->
          <script>
            var showDetails = document.querySelectorAll('#detail');

            for (var i = 0; i < showDetails.length; i++) {
              showDetails[i].addEventListener('click', function(event){
                    var targetId = event.target.dataset.id
                    console.log(targetId) 
                    axios.get(`/apis/${targetId}/detail/`)
                    .then(res => {
                        console.log(res.data)

                        var download = document.querySelector('#download')
                        download.setAttribute('href', `/apis/${targetId}/download/`);
                        document.querySelector('.modal-body-div').innerHTML =''
                        document.querySelector('.modal-title').innerHTML = res.data.api_name
                        document.querySelector('.modal-body-div').innerHTML = 
                        '<div>최종수정일 : ' + res.data.latest_modified_date + '</div>' +
                        '<div>저작권자명 : ' + res.data.copyright + '</div>' +
                        '<div>라이센스 : ' + res.data.copyright_range + '</div>' +
                        '<div>다운로드수 : ' + res.data.download_users + '</div>'
                    })
                })
            }
          </script>

          <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

          <!-- Status -->
          <script>
            let api_pk = '';
            {% for api in apis %}
                document.querySelector('#api{{ api.pk }}').innerHTML = '';
                // 방법 2. DB에서 status 가져오기
                api_pk = {{ api.pk }};
                axios.get(`/apis/${api_pk}/status/`)
                .then(res => {
                  let status_code = res.data.latest_status

                  if(status_code == 'INFO-000'){
                    api_status = '정상';
                  } else if(status_code == 'INFO-100' ){
                      api_status = '인증키오류'
                  } else if(status_code == 'ERROR-500' ){
                      api_status = '서버오류'
                  } else if(status_code == 'ERROR-600'){
                      api_status = '데이터베이스오류'
                  } else if(status_code == 'ERROR-601'){
                      api_status = 'SQL문장오류'
                  } else {
                      api_status = '비정상'
                  }
                    document.querySelector('#api{{ api.pk }}').innerHTML = api_status;
                })
            {% endfor %}
          </script>

          
          <!-- The Modal -->
          <div class="modal fade" id="modal-detail">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
              
                <!-- Modal Header -->
                <div class="modal-header">
                  <h4 class="modal-title">api 명을 정확히 입력해주세요</h4>
                  <button type="button" class="close" data-dismiss="modal">&times;</button>
                </div>
                
                <!-- Modal body -->
                <div class="modal-body">
                  <div class="modal-body-div"></div>
                  <div id="chartdiv"></div>
                </div>
                
                <!-- Modal footer -->
                <div class="modal-footer">
                  <a id="download" href="" download><button id="download" type="button" class="btn btn-primary">다운로드</button></a>
                  <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>          

        <div class="row">
          <div class="col-md-6 grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Ranking</h4>
                  <table class="table">
                    <thead>
                      <tr>
                        <th>
                          No.
                        </th>
                        <th>
                          Name
                        </th>
                        <th>
                          Progress
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>
                          1
                        </td>
                        <td>
                          Herman Beck
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-success" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          2
                        </td>
                        <td>
                          Messsy Adam
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-danger" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          3
                        </td>
                        <td>
                          John Richards
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-warning" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          4
                        </td>
                        <td>
                          Peter Meggik
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-primary" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          5
                        </td>
                        <td>
                          Edward
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-danger" role="progressbar" style="width: 35%" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          5
                        </td>
                        <td>
                          Ronald
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-info" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>                                                   
              </div>
            </div>
          </div>
          <div class="col-md-6 grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title">Ranking</h4>
                                    <table class="table">
                    <thead>
                      <tr>
                        <th>
                          No.
                        </th>
                        <th>
                          Name
                        </th>
                        <th>
                          Progress
                        </th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>
                          1
                        </td>
                        <td>
                          Herman Beck
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-success" role="progressbar" style="width: 25%" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          2
                        </td>
                        <td>
                          Messsy Adam
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-danger" role="progressbar" style="width: 75%" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          3
                        </td>
                        <td>
                          John Richards
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-warning" role="progressbar" style="width: 90%" aria-valuenow="90" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          4
                        </td>
                        <td>
                          Peter Meggik
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-primary" role="progressbar" style="width: 50%" aria-valuenow="50" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          5
                        </td>
                        <td>
                          Edward
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-danger" role="progressbar" style="width: 35%" aria-valuenow="35" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          5
                        </td>
                        <td>
                          Ronald
                        </td>
                        <td>
                          <div class="progress">
                            <div class="progress-bar bg-gradient-info" role="progressbar" style="width: 65%" aria-valuenow="65" aria-valuemin="0" aria-valuemax="100"></div>
                          </div>
                        </td>
                      </tr>
                    </tbody>
                  </table>                                                   
              </div>
            </div>
          </div>
        </div>
        <div class="row">
        </div>
        <!-- content-wrapper ends -->
        <!-- partial:partials/_footer.html -->
        {% include 'footer.html' %}
        <!-- partial -->
      </div>
      <!-- main-panel ends -->
    </div>
{% endblock %}

{% block script %}
  <!-- plugins:js -->
  <script src="{% static 'vendors/js/vendor.bundle.base.js' %}"></script>
  <script src="{% static 'vendors/js/vendor.bundle.base.js' %}"></script>
  <script src="{% static 'vendors/js/vendor.bundle.addons.js' %}"></script>
  <!-- endinject -->
  <!-- Plugin js for this page-->
  <!-- End plugin js for this page-->
  <!-- inject:js -->
  <script src="{% static 'js/off-canvas.js' %}"></script>
  <script src="{% static 'js/misc.js' %}"></script>
  <!-- endinject -->
  <!-- Custom js for this page-->
  <script src="{% static 'js/chart.js' %}"></script>
  <script src="{% static 'js/dashboard.js' %}"></script>
{% endblock  %}
